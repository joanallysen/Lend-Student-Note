<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Detail Before Buying</title>
</head>
<body class="m-10">
    <div class="flex justify-center text-center flex-row bg-gray-300 space-x-20 p-20">
        {% if note.image_filename != '' %}
            <img class="w-100" src="{{url_for('static', filename='uploads/' + note.image_filename)}}" alt="Note poster">
        {% endif %}

        <div class="text-left space-y-4 w-100">
            <p class="text-4xl font-bold">{{note.title}} <span class="text-2xl text-gray-400">{{note.isbn}}</span></p>
            <p class="text-5xl font-bold">${{note.price}}</p>
            <p>{{note.description}}</p>

            <p>Condition <span class="border-2 border-red-50 bg-red-50 rounded">{{note.condition}}</span></p>
            <p>Pickup Location {{note.pickup_location}}</p>

            <form action="shopping_cart_bp.shopping_cart/add_to_cart" method="POST" class="space-y-4">
                <!-- so shopping cart can have note id -->
                <input type="hidden" name="note_id" value="{{note.id}}">

                <label for="buying_type">Lend / Buy</label> <br>
                <select name="buying_type" id="buying_type" class="w-full  bg-white border-gray-200 p-3">
                    {% if note.listing_type == 'BOTH' or note.listing_type == 'RENTAL'%}
                        <option value="LEND">Lend</option>
                    {% endif %}
                    {% if note.listing_type == 'BOTH' or note.listing_type == 'SALE' %} 
                        <option value="BUY">Buy</option>
                    {% endif%}
                </select>

                <div id="rental_options" {% if note.listing_type == 'SALE' %} class="hidden space-y-4" {% endif %}>
                    <label for="start_date">Choose Start Borrowing Date</label> <br>
                    <input type="text" id="start_date" name="start_date" class="w-full p-3 bg-white border-gray-200" required> 
                
                    <label for="end_date">Choose End Borrowing Date</label> <br>
                    <input type="text" id="end_date" name="end_date" class="w-full p-3 bg-white border-gray-200" required>
                </div>
            
                <input id="purchase_button" class="p-4 bg-white rounded-2xl font-bold cursor-pointer" type="submit" value="{% if note.listing_type == 'BOTH' %}Lend{% else %}Buy{% endif %}">
            </form>
        </div>
    </div>

    <!-- TODO LINK THIS WITH SHOPPING CART -->
    <!-- If user has lended this book, have the ability to rate -->
    <!-- {if user.history.note_id = note_id  -->
    <!-- { endif -->
   <div class="">
        <h2>Rate this note or book!</h2>

        <div id="starRating" class="flex justify-center space-x-1 text-3xl text-yellow-400 cursor-pointer">
        </div>
        <form action="review.add_review/{{note.note_id}}" method="POST">
            <input id="ratingValue" value="" required>
            <label for="review">Review</label>
            <input type="text" name="review">
            <input type="submit" name="submit">
        </form>
    </div>



    <div>
        <h2 class="text-5xl">Review</h2>

    </div>


    <script>
        


        const listingType = '{{note.listing_type}}';
        const availableDate = '{{note.available_date}}';

        

        let startPicker, endPicker;

        startPicker = flatpickr('#start_date', {
            minDate: availableDate,
            onChange: function(selectedDates, dateStr, instance){
                if (selectedDates.length > 0){
                    const minEndDate = new Date(selectedDates[0]);
                    minEndDate.setDate(minEndDate.getDate() + 1);
                    endPicker.set('minDate', minEndDate)
                }
            }
        });

        endPicker = flatpickr('#end_date', {
            minDate: new Date(availableDate).setDate(new Date(availableDate).getDate() + 1)
        })

        
        document.getElementById('buying_type').addEventListener('change', function() {
            const rentalOptions = document.getElementById('rental_options');
            const purchaseButton = document.getElementById('purchase_button')
            if (this.value === 'LEND'){
                rentalOptions.style.display = 'block';
                purchaseButton.value = 'Borrow'
            } else{
                rentalOptions.style.display = 'none';
                purchaseButton.value = 'Buy'
            }
        })


        const starContainer = document.getElementById('starRating');
        const ratingValue = document.getElementById('ratingValue');
        const maxStars = 5;
        let currentRating = 0;


        for (let i = 1; i <= maxStars; i++) {
            const star = document.createElement('span');
            star.innerHTML = 'â˜…';
            star.dataset.value = i;

            star.addEventListener('mouseover', () => {
                highlightStars(i);
            });

            star.addEventListener('click', () => {
                currentRating = i;
                ratingValue.value = currentRating;
            });

            star.addEventListener('mouseleave', () => {
                highlightStars(currentRating);
            });

            starContainer.appendChild(star);
        }

        function highlightStars(rating) {
            const stars = starContainer.querySelectorAll('span');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-yellow-400');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.remove('text-yellow-400');
                    star.classList.add('text-gray-300');
                }
            });
        }

        highlightStars(0);
    </script>
</body>
</html>

