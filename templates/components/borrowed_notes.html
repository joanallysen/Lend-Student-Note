{% set current_path = request.path %}
{% import 'components/macros.html' as comp %}

{# Calculate statistics from History, not that efficinet #}
{% set borrowed_notes = user.notes_bought | selectattr('status', 'in', ['LENT', 'NEED ACTION']) | list %}
{% set current_borrowed = borrowed_notes | list | length %}
{% set total_borrowed = user.purchases | selectattr('transaction_type', 'equalto', 'BORROW') | list | length %}
{% set next_return_date = borrowed_notes | map(attribute='incoming_return_date') | select('ne', None) | sort | first %}
{% set total_purchased = user.purchases | list | length %}

<div class="mb-8">
    <h1 class="text-4xl font-bold mb-6">Borrowed Notes</h1>

    {# Statistics Cards #}
        <div class="grid grid-cols-4 gap-4 mb-8">
            {# Current Borrowed #}
        <div class="bg-white rounded-lg shadow p-6 flex items-start gap-4">
            <div class="bg-gray-100 rounded-lg p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">Current Borrowed</p>
                <p class="text-2xl font-semibold">{{ current_borrowed }} notes</p>
            </div>
        </div>
        {# Total Borrowed #}
        <div class="bg-white rounded-lg shadow p-6 flex items-start gap-4">
            <div class="bg-gray-100 rounded-lg p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">Total Borrowed</p>
                <p class="text-2xl font-semibold">{{ total_borrowed }} notes</p>
            </div>
        </div>
        {# Next Return Date #}
        <div class="bg-white rounded-lg shadow p-6 flex items-start gap-4">
            <div class="bg-gray-100 rounded-lg p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">Next Return Date</p>
                <p class="text-xl font-semibold">
                    {% if next_return_date %}
                        {{ next_return_date.strftime("%d %B %Y") }}
                    {% else %}
                        No incoming return date!
                    {% endif %}
                </p>
            </div>
        </div>
        {# Notes Since Start #}
        <div class="bg-white rounded-lg shadow p-6 flex items-start gap-4">
            <div class="bg-gray-100 rounded-lg p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">Borrowed or Buyed Notes</p>
                <p class="text-2xl font-semibold">{{ total_purchased }} notes</p>
            </div>
        </div>
        </div>

        {# Notes Grid #}
        {% if borrowed_notes %}
        <div class="grid grid-cols-4 gap-6">

            {% for note in borrowed_notes %}
                {{ comp.borrowed_card(note) }}
            {% endfor %}
        </div>
        {% else %}
                <!-- Empty Borrowed State -->
                <div class="flex flex-col items-center justify-center py-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-32 h-32 text-gray-300 mb-6" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                    </svg>
                    <h2 class="text-2xl font-bold text-gray-700 mb-3">No Borrowed Notes Yet</h2>
                    <p class="text-gray-500 mb-8 text-center max-w-md">
                        You haven't borrowed or bought any notes yet. Start exploring to find books you like!
                    </p>
                    <a href="{{ url_for('explore') }}" class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md hover:shadow-lg">
                        Browse Notes
                    </a>
                </div>
        {% endif %}
</div>
